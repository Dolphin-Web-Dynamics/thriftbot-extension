#!/usr/bin/env bash

# Auto-bump patch version when extension source files are changed.
# Only bumps if staged changes include files that affect the built extension.

EXTENSION_PATTERN="^(entrypoints/|lib/|wxt\.config\.ts|public/)"

# Check if any staged files match extension source patterns
CHANGED=$(git diff --cached --name-only | grep -E "$EXTENSION_PATTERN")

if [ -z "$CHANGED" ]; then
  exit 0
fi

# Read current version from package.json
CURRENT=$(node -p "require('./package.json').version")
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
NEW_PATCH=$((PATCH + 1))
NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"

# Update version in package.json (without npm version to avoid extra commits/tags)
node -e "
const fs = require('fs');
const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
pkg.version = '$NEW_VERSION';
fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
"

# Re-stage package.json with the bumped version
git add package.json

echo "[thriftbot] Auto-bumped version: $CURRENT â†’ $NEW_VERSION"
